name: Local runner test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  BuildApplication:
    runs-on: [self-hosted]
    defaults:
      run:
        shell: pwsh
    env:
      Solution_Name: ApplicationSettings.sln                       # Replace with your solution name, i.e. MyWpfApp.sln.
      Test_Project_Path:  GitWorkflowRun/ApplicationSettings/ApplicationSettings.csproj            
      Wap_Project_Directory: GitWorkflowRun/ApplicationSettings/
      Wap_Project_Path: GitWorkflowRun/ApplicationSettings/Artifacts/ 
    steps:
      - uses: actions/checkout@v2
      - name: Create Build Directory
        run: mkdir _build
      - name: Restore Packages
        run: nuget restore $env:Solution_Name
      - name: Build the application
        run: |
            msbuild.exe $env:Solution_Name /p:DeployOnBuild=true /p:OutputPath="../_build" /p:DeleteExistingFiles=True /p:platform="Any CPU" /p:configuration="Release" /p:ApplicationVersion="1.2.3.4" /p:MinimumRequiredVersion="1.2.3.4" /p:PublishVersion="1.2.3.4" 
      - uses: vimtor/action-zip@v1
        with:
           files: _build
           dest: GitWorkflowRun/result.zip
      - uses: shallwefootball/s3-upload-action@master
        name: Upload to S3
        id: S3 
        with:
          aws_key_id: AKIA2FPDD2Y7IJ2GEPLK
          aws_secret_access_key: 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
          aws_bucket: shailencodedeploy
          source_dir: 'GitWorkflowRun/'
      - name: SetOuput
        run: |
          echo ${{ steps.S3.outputs.object_key }} >> $GITHUB_OUTPUT
